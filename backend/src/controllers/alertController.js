const asyncHandler = require('express-async-handler');
const Alert = require('../models/Alert');
const { sendMail } = require('../utils/sendmail');

// Resolve an alert by id (sets status to 'Resolved')
const resolveAlert = asyncHandler(async (req, res) => {
  const { id } = req.params;
  const alert = await Alert.findById(id);
  if (!alert) {
    res.status(404);
    throw new Error('Alert not found');
  }

  const now = new Date();
  alert.status = 'Resolved';
  alert.resolvedAt = now;
  // compute duration from createdAt to now (ms)
  try {
    if (alert.createdAt) {
      alert.durationMs = now.getTime() - new Date(alert.createdAt).getTime();
    }
  } catch (e) {
    alert.durationMs = null;
  }

  // compute durationStr HH:MM:SS
  if (typeof alert.durationMs === 'number') {
    const totalSeconds = Math.max(0, Math.floor(alert.durationMs / 1000));
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    const pad = (n) => String(n).padStart(2, '0');
    alert.durationStr = `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
  } else {
    alert.durationStr = '00:00:00';
  }

  await alert.save();

  // record system log (best-effort)
  try {
    const { recordLog } = require('../middleware/logger');
    await recordLog({ req, actorType: 'victim', actorId: alert.victimID || null, action: 'alert_resolved', details: `Alert ${alert.alertID} resolved` });
  } catch (e) {
    console.warn('Failed to record alert resolved log', e && e.message);
  }

  res.status(200).json({ success: true, message: 'Alert resolved', data: { id: alert._id, alertID: alert.alertID, resolvedAt: alert.resolvedAt, durationMs: alert.durationMs, durationStr: alert.durationStr } });
});

// List alerts with optional filters (status)
const listAlerts = asyncHandler(async (req, res) => {
  const { status } = req.query;
  const filter = {};
  if (status) filter.status = status;
  const alerts = await Alert.find(filter).sort({ createdAt: -1 }).populate('victimID');
  res.status(200).json({ success: true, data: alerts });
});

module.exports = { resolveAlert, listAlerts };

// Send SOS email containing a Google Maps link to a fixed recipient.
// POST /api/alerts/:id/sos
const sendSOSEmail = asyncHandler(async (req, res) => {
  const { id } = req.params;

  const alert = await Alert.findById(id).populate('victimID');
  if (!alert) {
    res.status(404);
    throw new Error('Alert not found');
  }

  const lat = alert.location?.latitude;
  const lng = alert.location?.longitude;

  if (typeof lat !== 'number' || typeof lng !== 'number') {
    res.status(400);
    throw new Error('Alert does not have valid latitude/longitude');
  }

  const mapsLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(lat + ',' + lng)}`;
  const subject = `SOS Alert â€” ${alert.alertID || 'Unknown ID'}`;
  const victimInfo = alert.victimID ? `${alert.victimID.firstName || ''} ${alert.victimID.lastName || ''}`.trim() || `Victim: ${alert.victimID._id}` : 'Victim: unknown';

  const html = `
    <p><strong>Emergency SOS</strong></p>
    <p>${victimInfo}</p>
    <p>Alert ID: <b>${alert.alertID}</b></p>
    <p>Location: <a href="${mapsLink}" target="_blank" rel="noopener noreferrer">${lat}, ${lng}</a></p>
    <p>Time: ${new Date(alert.createdAt).toLocaleString()}</p>
    <hr>
    <p>This message was generated by the VAWCare Barangay Support System.</p>
  `;

  // Build recipient list: default SOS recipient + any emergency contact emails on victim
  const recipients = new Set();
  const defaultRecipient = process.env.SOS_RECIPIENT || 'jadenyuki486@gmail.com';
  recipients.add(defaultRecipient);

  if (alert.victimID && Array.isArray(alert.victimID.emergencyContacts)) {
    for (const c of alert.victimID.emergencyContacts) {
      if (c && c.email && typeof c.email === 'string' && c.email.trim()) {
        recipients.add(c.email.trim().toLowerCase());
      }
    }
  }

  const results = [];
  // record that SOS processing started
  try { const { recordLog } = require('../middleware/logger'); await recordLog({ req, actorType: req.user?.role || 'victim', actorId: req.user?._id || alert.victimID || null, action: 'send_sos', details: `SOS processing started for alert ${alert.alertID || alert._id}` }); } catch(e) { console.warn('Failed to record send_sos log', e && e.message); }
  for (const recipient of Array.from(recipients)) {
    try {
      await sendMail(recipient, subject, html);
      try {
        await alert.addNotifiedContact({
          contactID: `email-${recipient}`,
          name: (alert.victimID && alert.victimID.emergencyContacts ? (alert.victimID.emergencyContacts.find(ec => (ec.email || '').toLowerCase() === recipient) || {}).name : '') || recipient,
          contactNumber: (alert.victimID && alert.victimID.emergencyContacts ? (alert.victimID.emergencyContacts.find(ec => (ec.email || '').toLowerCase() === recipient) || {}).contactNumber : '') || '',
          notificationTime: new Date(),
          notificationStatus: 'Sent'
        });
      } catch (e) {
        console.warn('Failed to record notified contact', e && e.message);
      }
      results.push({ recipient, status: 'Sent' });
    } catch (err) {
      console.error('Failed to send SOS email to', recipient, err && err.message);
      try {
        await alert.addNotifiedContact({
          contactID: `email-${recipient}`,
          name: (alert.victimID && alert.victimID.emergencyContacts ? (alert.victimID.emergencyContacts.find(ec => (ec.email || '').toLowerCase() === recipient) || {}).name : '') || recipient,
          contactNumber: (alert.victimID && alert.victimID.emergencyContacts ? (alert.victimID.emergencyContacts.find(ec => (ec.email || '').toLowerCase() === recipient) || {}).contactNumber : '') || '',
          notificationTime: new Date(),
          notificationStatus: 'Failed'
        });
      } catch (e) { /* ignore */ }
      results.push({ recipient, status: 'Failed' });
    }
  }

  // Record per-recipient results
  try {
    const { recordLog } = require('../middleware/logger');
    for (const r of results) {
      const act = r.status === 'Sent' ? 'sos_email_sent' : 'sos_email_failed';
      try { await recordLog({ req, actorType: req.user?.role || 'victim', actorId: alert.victimID || null, action: act, details: `SOS email ${r.status} to ${r.recipient} for alert ${alert.alertID || alert._id}` }); } catch(e) { /* ignore */ }
    }
  } catch(e) { console.warn('Failed to record per-recipient SOS logs', e && e.message); }

  // If any recipient succeeded, return success
  if (results.some(r => r.status === 'Sent')) {
    res.status(200).json({ success: true, message: 'SOS email(s) processed', results });
  } else {
    res.status(500).json({ success: false, message: 'Failed to send SOS emails', results });
  }
});

// export additional function
module.exports = { resolveAlert, listAlerts, sendSOSEmail };
